<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sols RNG – Aura Roller (Full Offline Mock)</title>
<style>
  :root{
    --bg:#0b0f18;
    --panel:#111827;
    --panel2:#0f172a;
    --card:#121a2f;
    --card2:#0e162a;
    --text:#e5e7eb;
    --muted:#9ca3af;
    --muted2:#6b7280;
    --line:#22304a;
    --accent:#38bdf8;
    --accent2:#a78bfa;
    --good:#34d399;
    --warn:#fbbf24;
    --bad:#fb7185;
    --shadow: 0 10px 30px rgba(0,0,0,.35);
    --radius: 16px;
    --radius2: 12px;
    --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
  }
  body.light{
    --bg:#f5f7ff;
    --panel:#ffffff;
    --panel2:#f3f6ff;
    --card:#ffffff;
    --card2:#f6f8ff;
    --text:#0b1220;
    --muted:#4b5563;
    --muted2:#6b7280;
    --line:#dbe4ff;
    --shadow: 0 10px 30px rgba(20,30,60,.12);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family:var(--font);
    background: radial-gradient(1200px 700px at 30% -10%, rgba(56,189,248,.18), transparent 60%),
                radial-gradient(1000px 600px at 90% 10%, rgba(167,139,250,.14), transparent 60%),
                var(--bg);
    color:var(--text);
  }

  /* Layout */
  .app{
    display:grid;
    grid-template-columns: 320px 1fr 340px;
    gap:14px;
    padding:14px;
    min-height:100vh;
  }
  @media (max-width: 1200px){
    .app{grid-template-columns: 300px 1fr; grid-template-rows:auto auto}
    .right{grid-column:1 / -1}
  }
  @media (max-width: 900px){
    .app{grid-template-columns: 1fr; grid-template-rows:auto auto auto}
    .left,.center,.right{grid-column:1/-1}
  }

  .panel{
    background: linear-gradient(180deg, rgba(255,255,255,.04), transparent 35%), var(--panel);
    border:1px solid var(--line);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    overflow:hidden;
  }
  .panelHeader{
    padding:14px 14px 10px 14px;
    border-bottom:1px solid var(--line);
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
  }
  .panelTitle{
    display:flex; flex-direction:column; gap:2px;
  }
  .panelTitle h2{
    margin:0;
    font-size:14px;
    letter-spacing:.08em;
    text-transform:uppercase;
    color:var(--muted);
    font-weight:700;
  }
  .panelTitle .sub{
    font-size:12px;
    color:var(--muted2);
  }
  .panelBody{padding:14px}

  /* Buttons / Inputs */
  button, input, select{
    font-family:inherit;
  }
  .btn{
    border:1px solid rgba(56,189,248,.35);
    background: linear-gradient(180deg, rgba(56,189,248,.18), rgba(56,189,248,.08));
    color:var(--text);
    padding:10px 12px;
    border-radius: 12px;
    cursor:pointer;
    transition: transform .06s ease, filter .12s ease, background .12s ease;
    user-select:none;
  }
  .btn:hover{filter:brightness(1.06)}
  .btn:active{transform: translateY(1px)}
  .btn.secondary{
    border:1px solid rgba(167,139,250,.35);
    background: linear-gradient(180deg, rgba(167,139,250,.18), rgba(167,139,250,.08));
  }
  .btn.ghost{
    border:1px solid var(--line);
    background: transparent;
  }
  .btn.danger{
    border:1px solid rgba(251,113,133,.35);
    background: linear-gradient(180deg, rgba(251,113,133,.18), rgba(251,113,133,.08));
  }
  .btn.small{padding:8px 10px; border-radius: 10px; font-size:12px}
  .btn.big{padding:14px 16px; border-radius: 16px; font-size:14px; font-weight:800; letter-spacing:.02em}

  .field{
    display:flex; flex-direction:column; gap:6px;
  }
  .field label{font-size:12px; color:var(--muted); letter-spacing:.02em}
  .row{display:flex; gap:10px; align-items:center}
  .row.wrap{flex-wrap:wrap}
  .split{display:flex; justify-content:space-between; gap:10px; align-items:center}
  .pill{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding:8px 10px;
    border:1px solid var(--line);
    border-radius: 999px;
    background: rgba(255,255,255,.03);
    font-size:12px;
    color:var(--muted);
    white-space:nowrap;
  }
  .pill strong{color:var(--text)}
  .input, select{
    width:100%;
    border:1px solid var(--line);
    background: rgba(255,255,255,.03);
    color:var(--text);
    padding:10px 12px;
    border-radius: 12px;
    outline:none;
  }
  .input:focus, select:focus{border-color: rgba(56,189,248,.55)}
  .divider{height:1px; background:var(--line); margin:12px 0}

  /* Tabs */
  .tabs{
    display:flex;
    gap:8px;
    padding:10px 14px;
    border-bottom:1px solid var(--line);
    background: linear-gradient(180deg, rgba(255,255,255,.03), transparent);
  }
  .tab{
    padding:8px 10px;
    border-radius: 999px;
    border:1px solid var(--line);
    background: transparent;
    color:var(--muted);
    cursor:pointer;
    font-size:12px;
  }
  .tab.active{
    color:var(--text);
    border-color: rgba(56,189,248,.45);
    background: rgba(56,189,248,.10);
  }

  /* Lists */
  .list{display:flex; flex-direction:column; gap:10px}
  .card{
    background: linear-gradient(180deg, rgba(255,255,255,.04), transparent 60%), var(--card);
    border:1px solid var(--line);
    border-radius: var(--radius2);
    padding:12px;
  }
  .cardHeader{display:flex; align-items:flex-start; justify-content:space-between; gap:10px}
  .cardTitle{display:flex; flex-direction:column; gap:3px}
  .cardTitle .name{font-weight:900; letter-spacing:.01em}
  .cardTitle .meta{font-size:12px; color:var(--muted)}
  .badge{
    display:inline-flex; align-items:center; gap:6px;
    padding:6px 10px;
    border-radius: 999px;
    border:1px solid var(--line);
    background: rgba(255,255,255,.03);
    font-size:12px;
    color:var(--muted);
    white-space:nowrap;
  }
  .badge.good{border-color: rgba(52,211,153,.35); background: rgba(52,211,153,.10); color:var(--good)}
  .badge.warn{border-color: rgba(251,191,36,.35); background: rgba(251,191,36,.10); color:var(--warn)}
  .badge.bad{border-color: rgba(251,113,133,.35); background: rgba(251,113,133,.10); color:var(--bad)}
  .kv{
    display:grid;
    grid-template-columns: 1fr auto;
    gap:8px;
    font-size:12px;
    color:var(--muted);
    margin-top:8px;
  }
  .kv b{color:var(--text); font-weight:800}

  /* Tooltip */
  .hasTip{position:relative}
  .tip{
    position:absolute;
    z-index:50;
    left:0;
    bottom:calc(100% + 8px);
    width: min(280px, 70vw);
    padding:10px 10px;
    border-radius: 12px;
    border:1px solid var(--line);
    background: rgba(15,23,42,.92);
    box-shadow: var(--shadow);
    color:var(--text);
    font-size:12px;
    display:none;
  }
  body.light .tip{background: rgba(255,255,255,.96)}
  .hasTip:hover .tip{display:block}
  .tip .tTitle{font-weight:900; margin-bottom:4px}
  .tip .tRow{color:var(--muted); line-height:1.35}
  .tip .tRow b{color:var(--text)}
  .tip:after{
    content:"";
    position:absolute;
    left:14px;
    top:100%;
    width:10px; height:10px;
    background: inherit;
    border-right:1px solid var(--line);
    border-bottom:1px solid var(--line);
    transform: rotate(45deg);
  }

  /* Center game area */
  .centerInner{
    padding:14px;
    display:flex;
    flex-direction:column;
    gap:12px;
    min-height: calc(100vh - 28px);
  }

  .topStorageBar{
    position:sticky;
    top:12px;
    z-index:5;
    background: linear-gradient(180deg, rgba(255,255,255,.04), transparent 55%), var(--panel2);
    border:1px solid var(--line);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    overflow:hidden;
  }
  .topStorageHeader{
    padding:10px 12px;
    display:flex;
    gap:10px;
    align-items:center;
    justify-content:space-between;
    border-bottom:1px solid var(--line);
  }
  .brand{
    display:flex; gap:10px; align-items:center;
  }
  .logo{
    width:34px; height:34px; border-radius: 12px;
    background: radial-gradient(circle at 30% 20%, rgba(56,189,248,.9), rgba(167,139,250,.65) 50%, rgba(0,0,0,.15) 80%);
    border:1px solid rgba(255,255,255,.10);
  }
  .brandTxt{
    display:flex; flex-direction:column; line-height:1.1;
  }
  .brandTxt .t1{font-weight:1000; letter-spacing:.02em}
  .brandTxt .t2{font-size:12px; color:var(--muted)}
  .topControls{
    display:flex; gap:8px; align-items:center; flex-wrap:wrap;
  }

  .storageContent{
    padding:12px;
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:10px;
  }
  @media(max-width: 900px){
    .storageContent{grid-template-columns: 1fr}
  }
  .miniPanel{
    background: linear-gradient(180deg, rgba(255,255,255,.03), transparent 70%), rgba(0,0,0,.08);
    border:1px solid var(--line);
    border-radius: var(--radius2);
    padding:10px;
  }
  .miniHeader{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:8px}
  .miniHeader .h{font-size:12px; font-weight:900; letter-spacing:.08em; color:var(--muted); text-transform:uppercase}
  .miniHeader .count{font-size:12px; color:var(--muted)}
  .miniList{
    display:flex; flex-direction:column; gap:8px; max-height:220px; overflow:auto; padding-right:2px;
  }
  .miniItem{
    display:flex; align-items:center; justify-content:space-between; gap:10px;
    padding:8px 10px;
    border:1px solid var(--line);
    border-radius: 12px;
    background: rgba(255,255,255,.03);
  }
  .miniItem .lefty{display:flex; flex-direction:column; gap:2px}
  .miniItem .n{font-weight:900; font-size:13px}
  .miniItem .m{font-size:12px; color:var(--muted)}
  .miniItem .qty{font-weight:900; color:var(--text)}
  .miniItem .actions{display:flex; gap:6px; align-items:center}

  /* Roll zone */
  .rollZone{
    flex:1;
    display:flex;
    flex-direction:column;
    gap:12px;
    background: linear-gradient(180deg, rgba(255,255,255,.03), transparent 40%), var(--panel2);
    border:1px solid var(--line);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    padding:14px;
    position:relative;
  }
  .rollTop{
    display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap; align-items:center;
  }
  .statsRow{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
  .statBox{
    padding:10px 12px;
    border:1px solid var(--line);
    border-radius: 14px;
    background: rgba(255,255,255,.03);
    min-width: 180px;
  }
  .statBox .k{font-size:12px; color:var(--muted); letter-spacing:.08em; text-transform:uppercase}
  .statBox .v{font-size:18px; font-weight:1000; margin-top:4px}
  .statBox .s{font-size:12px; color:var(--muted); margin-top:2px}

  .rollButtons{
    display:grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap:10px;
    align-items:stretch;
    margin-top:6px;
  }
  @media(max-width: 900px){
    .rollButtons{grid-template-columns: 1fr}
  }
  .rollButtons .leftMini, .rollButtons .rightMini{
    display:flex; gap:10px; align-items:center; justify-content:space-between;
  }
  .rollButtons .leftMini .btn, .rollButtons .rightMini .btn{flex:1}
  .rollButtons .mainRoll .btn{width:100%}
  .rollButtons .mainRoll{display:flex}

  .buffStrip{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    margin-top:6px;
    justify-content:flex-end;
  }
  .buffBox{
    position:relative;
    padding:8px 10px;
    border-radius: 12px;
    border:1px solid var(--line);
    background: rgba(255,255,255,.03);
    font-size:12px;
    color:var(--text);
    display:flex;
    gap:8px;
    align-items:center;
  }
  .buffBox .t{font-weight:900}
  .buffBox .muted{color:var(--muted)}
  .buffBox.on{border-color: rgba(56,189,248,.5); background: rgba(56,189,248,.10)}
  .buffBox.bad{border-color: rgba(251,113,133,.5); background: rgba(251,113,133,.08)}
  .buffBox.good{border-color: rgba(52,211,153,.5); background: rgba(52,211,153,.08)}
  .buffBox.warn{border-color: rgba(251,191,36,.5); background: rgba(251,191,36,.08)}
  .buffBox .tip{left:auto; right:0}
  .buffBox .tip:after{left:auto; right:14px}

  /* Bottom left biome/day */
  .bottomLeft{
    position:absolute;
    left:14px;
    bottom:14px;
    display:flex;
    flex-direction:column;
    gap:10px;
    width:min(360px, 90%);
  }
  .selectorCard{
    padding:10px;
    border:1px solid var(--line);
    border-radius: 14px;
    background: rgba(255,255,255,.03);
    display:flex;
    gap:10px;
    align-items:center;
    justify-content:space-between;
  }
  .selectorCard .lbl{font-size:12px; color:var(--muted); font-weight:800; letter-spacing:.08em; text-transform:uppercase}
  .selectorCard .val{font-weight:1000}
  .selectorCard select{max-width:190px}

  /* Right panel: last rolled auras */
  .historyList{
    display:flex;
    flex-direction:column;
    gap:10px;
    max-height: calc(100vh - 180px);
    overflow:auto;
    padding-right:2px;
  }
  .historyItem{
    padding:12px;
    border:1px solid var(--line);
    border-radius: var(--radius2);
    background: linear-gradient(180deg, rgba(255,255,255,.03), transparent 65%), var(--card2);
  }
  .historyItem .top{display:flex; justify-content:space-between; gap:10px; align-items:flex-start}
  .historyItem .name{font-weight:1000}
  .historyItem .small{font-size:12px; color:var(--muted); margin-top:4px; line-height:1.25}
  .historyItem .time{font-size:12px; color:var(--muted2)}
  .historyItem .pill{margin-top:8px}

  /* Modal */
  .modalBackdrop{
    position:fixed; inset:0;
    background: rgba(0,0,0,.55);
    display:none;
    align-items:center;
    justify-content:center;
    padding:14px;
    z-index:100;
  }
  .modal{
    width:min(860px, 96vw);
    max-height: 92vh;
    overflow:auto;
    border-radius: 18px;
    border:1px solid var(--line);
    box-shadow: var(--shadow);
    background: var(--panel);
  }
  .modalHeader{
    padding:12px 14px;
    border-bottom:1px solid var(--line);
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
  }
  .modalHeader .title{font-weight:1000; letter-spacing:.02em}
  .modalBody{padding:14px}
  .grid2{display:grid; grid-template-columns: 1fr 1fr; gap:12px}
  @media(max-width: 900px){.grid2{grid-template-columns:1fr}}
  .hint{font-size:12px; color:var(--muted); line-height:1.35}

  .tiny{font-size:12px;color:var(--muted)}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace}

  /* Scrollbars */
  .miniList::-webkit-scrollbar, .historyList::-webkit-scrollbar, .modal::-webkit-scrollbar{
    width:10px;
  }
  .miniList::-webkit-scrollbar-thumb, .historyList::-webkit-scrollbar-thumb, .modal::-webkit-scrollbar-thumb{
    background: rgba(255,255,255,.12);
    border-radius: 999px;
    border: 2px solid transparent;
    background-clip: padding-box;
  }
  body.light .miniList::-webkit-scrollbar-thumb, body.light .historyList::-webkit-scrollbar-thumb, body.light .modal::-webkit-scrollbar-thumb{
    background: rgba(10,20,40,.18);
    border: 2px solid transparent;
    background-clip: padding-box;
  }
</style>
</head>
<body>
<div class="app">
  <!-- LEFT: Inventory / Items -->
  <section class="panel left">
    <div class="panelHeader">
      <div class="panelTitle">
        <h2>Item Inventory</h2>
        <div class="sub">Potions, items, gauntlets. Everything stacks here.</div>
      </div>
      <button class="btn ghost small" id="btnStartMenu">Your stats</button>
    </div>

    <div class="tabs" role="tablist" aria-label="Inventory tabs">
      <button class="tab active" data-invtab="gauntlets">Gauntlets</button>
      <button class="tab" data-invtab="potions">Potions & Items</button>
    </div>

    <div class="panelBody" style="padding-top:12px">
      <div id="invGauntlets" class="list"></div>
      <div id="invPotions" class="list" style="display:none"></div>

      <div class="divider"></div>

      <div class="row wrap">
        <button class="btn ghost small" id="btnExport">Export Save</button>
        <button class="btn ghost small" id="btnImport">Import Save</button>
        <button class="btn danger small" id="btnReset">Reset</button>
      </div>
      <div class="tiny" style="margin-top:8px">
        Save is stored locally in your browser (localStorage).
      </div>
    </div>
  </section>

  <!-- CENTER: Main UI -->
  <section class="center">
    <div class="centerInner">
      <!-- Top storage bar (about 1/3 from the top vibe) -->
      <div class="topStorageBar">
        <div class="topStorageHeader">
          <div class="brand">
            <div class="logo" aria-hidden="true"></div>
            <div class="brandTxt">
              <div class="t1">Sols RNG – Aura Roller</div>
              <div class="t2">Offline mock site • easy to edit data</div>
            </div>
          </div>

          <div class="topControls">
            <button class="btn ghost small" id="btnLight">Toggle Light</button>
            <span class="pill"><span>Version</span> <strong id="versionText">v0.1</strong></span>
          </div>
        </div>

        <div class="tabs" role="tablist" aria-label="Top tabs">
          <button class="tab active" data-toptab="storage">Aura Storage</button>
          <button class="tab" data-toptab="inventory">Aura Inventory</button>
          <button class="tab" data-toptab="edit">Quick Edit</button>
        </div>

        <div class="storageContent" id="topTabStorage">
          <div class="miniPanel">
            <div class="miniHeader">
              <div class="h">Aura Storage</div>
              <div class="count"><span id="storageCount">0</span> stored</div>
            </div>
            <div class="row" style="margin-bottom:8px">
              <input class="input" id="storageSearch" placeholder="Search stored auras…" />
            </div>
            <div class="miniList" id="storageList"></div>
            <div class="row wrap" style="margin-top:10px">
              <button class="btn ghost small" id="btnStoreLast">Store last rolled</button>
              <button class="btn danger small" id="btnClearStorage">Clear storage</button>
            </div>
            <div class="hint" style="margin-top:8px">
              Storage = your saved/aura-collection stash. (Top area like you requested.)
            </div>
          </div>

          <div class="miniPanel">
            <div class="miniHeader">
              <div class="h">Aura Inventory</div>
              <div class="count"><span id="invCount">0</span> total</div>
            </div>
            <div class="row" style="margin-bottom:8px">
              <input class="input" id="invSearch" placeholder="Search rolled auras…" />
            </div>
            <div class="miniList" id="invList"></div>
            <div class="row wrap" style="margin-top:10px">
              <button class="btn ghost small" id="btnClearInv">Clear inventory</button>
            </div>
            <div class="hint" style="margin-top:8px">
              Inventory = everything you’ve rolled (like “cutscene” list). Keep it or clear it.
            </div>
          </div>
        </div>

        <div class="storageContent" id="topTabInventory" style="display:none">
          <div class="miniPanel" style="grid-column:1/-1">
            <div class="miniHeader">
              <div class="h">Aura Inventory (Full)</div>
              <div class="count">Tip: click an aura in history → it appears here too</div>
            </div>
            <div class="row wrap" style="margin-bottom:10px">
              <input class="input" id="fullInvSearch" placeholder="Search…" />
              <select id="fullInvSort" class="input" style="max-width:220px">
                <option value="time_desc">Sort: newest</option>
                <option value="time_asc">Sort: oldest</option>
                <option value="rarity_desc">Sort: rarest</option>
                <option value="rarity_asc">Sort: commonest</option>
                <option value="name_asc">Sort: name A→Z</option>
              </select>
            </div>
            <div class="miniList" id="fullInvList" style="max-height:320px"></div>
          </div>
        </div>

        <div class="storageContent" id="topTabEdit" style="display:none">
          <div class="miniPanel">
            <div class="miniHeader">
              <div class="h">Edit Auras</div>
              <div class="count">Fast add/remove</div>
            </div>
            <div class="hint">
              Auras live in the <span class="mono">AURAS</span> array in the script. Add like:
              <div class="mono" style="margin-top:6px; padding:8px; border:1px solid var(--line); border-radius:12px; background:rgba(255,255,255,.03); overflow:auto;">
{ name: "Luminosity", rarity: 1200000000, class: "Transcendent", biome: "", nativeRarity: null, tags: ["Global"] }
              </div>
              <div style="margin-top:8px">
                <b>rarity</b> = the “N” in 1/N. No names get cut off (we don’t truncate).
              </div>
            </div>
            <div class="divider"></div>
            <div class="row wrap">
              <button class="btn secondary small" id="btnOpenAuraEditor">Open Aura Editor</button>
              <button class="btn ghost small" id="btnOpenPotionEditor">Open Potion Editor</button>
            </div>
          </div>

          <div class="miniPanel">
            <div class="miniHeader">
              <div class="h">Edit Potions</div>
              <div class="count">Durations + effects</div>
            </div>
            <div class="hint">
              Potions are in the <span class="mono">POTIONS</span> array. Effects support:
              <ul style="margin:8px 0 0 18px; padding:0; color:var(--muted); line-height:1.35">
                <li><b>luckAdd</b> (adds to luck multiplier: +0.25 = +25%)</li>
                <li><b>speedAdd</b> (adds to roll speed multiplier: +0.10 = +10%)</li>
                <li><b>nextRollLuckAdd</b> (one-time huge boost for next roll)</li>
                <li><b>negateAllBuffs</b> (Oblivion style)</li>
                <li><b>rollCharges</b> (Warp/Transcendent style: lasts X rolls)</li>
              </ul>
            </div>
            <div class="divider"></div>
            <div class="row wrap">
              <button class="btn ghost small" id="btnGiveTestItems">Give test items</button>
              <button class="btn danger small" id="btnStopAllBuffs">Stop all buffs</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Main rolling zone -->
      <div class="rollZone">
        <div class="rollTop">
          <div class="statsRow">
            <div class="statBox">
              <div class="k">Final Luck</div>
              <div class="v" id="statLuck">x1.00</div>
              <div class="s" id="statLuckBreakdown">Base x1.00</div>
            </div>
            <div class="statBox">
              <div class="k">Roll Speed</div>
              <div class="v" id="statSpeed">x1.00</div>
              <div class="s" id="statSpeedBreakdown">Base x1.00</div>
            </div>
            <div class="statBox">
              <div class="k">Next-Roll Luck</div>
              <div class="v" id="statNextLuck">+0</div>
              <div class="s">Consumed on your next roll</div>
            </div>
          </div>

          <div class="row wrap">
            <span class="pill"><span>Auto</span> <strong id="autoState">OFF</strong></span>
            <span class="pill"><span>Quick</span> <strong id="quickState">OFF</strong></span>
          </div>
        </div>

        <!-- Roll buttons row: auto (left), roll (center), quick (right) -->
        <div class="rollButtons">
          <div class="leftMini">
            <button class="btn secondary" id="btnAuto">Auto Roll</button>
            <button class="btn ghost" id="btnAutoSettings">Auto Settings</button>
          </div>

          <div class="mainRoll">
            <button class="btn big" id="btnRoll">ROLL</button>
          </div>

          <div class="rightMini">
            <button class="btn secondary" id="btnQuick">Quick Roll</button>
            <button class="btn ghost" id="btnMulti">Multi Roll</button>
          </div>
        </div>

        <!-- Buffs right below (small perfect sized boxes, right-to-left) -->
        <div class="buffStrip" id="buffStrip"></div>

        <!-- Bottom-left biome + day/night -->
        <div class="bottomLeft">
          <div class="selectorCard">
            <div>
              <div class="lbl">Biome</div>
              <div class="val" id="biomeLabel">None</div>
            </div>
            <select id="biomeSelect">
              <option value="">None</option>
              <option value="Heaven">Heaven</option>
              <option value="Hell">Hell</option>
              <option value="Corruption">Corruption</option>
              <option value="Starfall">Starfall</option>
              <option value="Windy">Windy</option>
              <option value="Rainy">Rainy</option>
              <option value="Snowy">Snowy</option>
              <option value="Sandstorm">Sandstorm</option>
              <option value="Cyberspace">Cyberspace</option>
              <option value="Null">Null</option>
              <option value="Limbo">Limbo</option>
              <option value="Dreamspace">Dreamspace</option>
            </select>
          </div>

          <div class="selectorCard">
            <div>
              <div class="lbl">Day / Night</div>
              <div class="val" id="timeLabel">Day</div>
            </div>
            <select id="timeSelect">
              <option value="Day">Day</option>
              <option value="Night">Night</option>
            </select>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- RIGHT: Last rolled auras -->
  <section class="panel right">
    <div class="panelHeader">
      <div class="panelTitle">
        <h2>Your last rolled auras</h2>
        <div class="sub">Newest at top • click to store</div>
      </div>
      <div class="row">
        <button class="btn ghost small" id="btnClearHistory">Clear</button>
      </div>
    </div>
    <div class="panelBody">
      <div class="historyList" id="historyList"></div>
      <div class="tiny" style="margin-top:10px">
        Tip: Add all your auras in the <span class="mono">AURAS</span> array (easy). Names never truncate.
      </div>
    </div>
  </section>
</div>

<!-- START MENU MODAL -->
<div class="modalBackdrop" id="startModal">
  <div class="modal">
    <div class="modalHeader">
      <div class="title">Your Stats Menu</div>
      <button class="btn ghost small" data-close="startModal">Close</button>
    </div>
    <div class="modalBody">
      <div class="grid2">
        <div class="card">
          <div class="cardHeader">
            <div class="cardTitle">
              <div class="name">Current Final Luck</div>
              <div class="meta">This is the multiplier used for rolls (affects odds).</div>
            </div>
            <span class="badge good" id="menuLuckBadge">x1.00</span>
          </div>
          <div class="kv" id="menuLuckBreakdown"></div>
        </div>

        <div class="card">
          <div class="cardHeader">
            <div class="cardTitle">
              <div class="name">Current Roll Speed</div>
              <div class="meta">Affects auto roll interval + quick roll throughput.</div>
            </div>
            <span class="badge warn" id="menuSpeedBadge">x1.00</span>
          </div>
          <div class="kv" id="menuSpeedBreakdown"></div>
        </div>

        <div class="card" style="grid-column:1/-1">
          <div class="cardHeader">
            <div class="cardTitle">
              <div class="name">How luck works here</div>
              <div class="meta">Simple + editable (you can change it fast)</div>
            </div>
          </div>
          <div class="hint" style="margin-top:10px">
            Each aura has a base rarity <b>1/N</b>. Your effective rarity becomes:
            <div class="mono" style="margin-top:8px; padding:10px; border:1px solid var(--line); border-radius:12px; background:rgba(255,255,255,.03)">
effectiveN = max(1, floor(N / finalLuck))
p = 1 / effectiveN
            </div>
            <div style="margin-top:10px">
              <b>Next-roll luck</b> adds on top of finalLuck for one roll only.
              <br/>
              If a potion says “negates all buffs” (Oblivion), we clear timed/roll buffs but keep base gear & VIP toggles.
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- MULTI ROLL MODAL -->
<div class="modalBackdrop" id="multiModal">
  <div class="modal">
    <div class="modalHeader">
      <div class="title">Multi Roll</div>
      <button class="btn ghost small" data-close="multiModal">Close</button>
    </div>
    <div class="modalBody">
      <div class="grid2">
        <div class="card">
          <div class="field">
            <label>How many rolls?</label>
            <input class="input" id="multiCount" type="number" min="1" value="10" />
          </div>
          <div class="row wrap" style="margin-top:10px">
            <button class="btn big" id="btnDoMulti">Roll Now</button>
            <button class="btn ghost" id="btnDoMultiFast">Fast x100</button>
          </div>
          <div class="hint" style="margin-top:10px">
            “Fast x100” ignores animations and just runs 100 rolls instantly.
          </div>
        </div>

        <div class="card">
          <div class="cardHeader">
            <div class="cardTitle">
              <div class="name">Current odds preview</div>
              <div class="meta">Shows effective rarity for your selected aura</div>
            </div>
          </div>
          <div class="field" style="margin-top:10px">
            <label>Select aura to preview</label>
            <select id="previewAura"></select>
          </div>
          <div class="divider"></div>
          <div class="kv" id="previewKv"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- AUTO SETTINGS MODAL -->
<div class="modalBackdrop" id="autoModal">
  <div class="modal">
    <div class="modalHeader">
      <div class="title">Auto Roll Settings</div>
      <button class="btn ghost small" data-close="autoModal">Close</button>
    </div>
    <div class="modalBody">
      <div class="grid2">
        <div class="card">
          <div class="field">
            <label>Auto roll target (stop when rolled this or rarer)</label>
            <select id="autoTarget"></select>
          </div>
          <div class="field" style="margin-top:10px">
            <label>Stop when effective rarity is ≤ (1/N)</label>
            <input class="input" id="autoStopN" type="number" min="1" value="1000000" />
          </div>
          <div class="hint" style="margin-top:10px">
            Auto will stop if you roll an aura with base rarity ≤ your chosen aura,
            OR if the rolled aura effective rarity (after luck) is at least as rare as 1/N here.
          </div>
        </div>

        <div class="card">
          <div class="cardHeader">
            <div class="cardTitle">
              <div class="name">Quick roll behavior</div>
              <div class="meta">Quick roll is like spam rolling but controlled.</div>
            </div>
          </div>
          <div class="field" style="margin-top:10px">
            <label>Quick roll batch size</label>
            <input class="input" id="quickBatch" type="number" min="1" value="10" />
          </div>
          <div class="field" style="margin-top:10px">
            <label>Quick roll interval (ms)</label>
            <input class="input" id="quickInterval" type="number" min="10" value="120" />
          </div>
          <div class="hint" style="margin-top:10px">
            Quick roll runs batches repeatedly. Roll speed also speeds auto, but quick roll is mostly batch-driven.
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- AURA EDITOR MODAL -->
<div class="modalBackdrop" id="auraEditorModal">
  <div class="modal">
    <div class="modalHeader">
      <div class="title">Aura Editor (easy add/edit)</div>
      <button class="btn ghost small" data-close="auraEditorModal">Close</button>
    </div>
    <div class="modalBody">
      <div class="card">
        <div class="hint">
          Paste JSON array of auras here. Format:
          <div class="mono" style="margin-top:8px; padding:10px; border:1px solid var(--line); border-radius:12px; background:rgba(255,255,255,.03)">
[
  {"name":"Luminosity","rarity":1200000000,"class":"Transcendent","biome":"","nativeRarity":null,"tags":["Global"]},
  {"name":"Equinox","rarity":2500000000,"class":"Transcendent","biome":"","nativeRarity":null,"tags":["Global"]}
]
          </div>
          <div style="margin-top:10px">
            <b>rarity</b> is the N in 1/N. Names don’t truncate.
          </div>
        </div>
        <textarea id="auraJson" class="input" style="height:260px; margin-top:12px; font-family: ui-monospace, monospace;"></textarea>
        <div class="row wrap" style="margin-top:10px">
          <button class="btn" id="btnLoadAurasFromJson">Load Auras</button>
          <button class="btn ghost" id="btnCopyAurasJson">Copy Current</button>
          <button class="btn danger" id="btnRestoreDefaultAuras">Restore Defaults</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- POTION EDITOR MODAL -->
<div class="modalBackdrop" id="potionEditorModal">
  <div class="modal">
    <div class="modalHeader">
      <div class="title">Potion Editor</div>
      <button class="btn ghost small" data-close="potionEditorModal">Close</button>
    </div>
    <div class="modalBody">
      <div class="card">
        <div class="hint">
          Paste JSON array of potions. Format:
          <div class="mono" style="margin-top:8px; padding:10px; border:1px solid var(--line); border-radius:12px; background:rgba(255,255,255,.03)">
[
  {"id":"LuckyPotion","name":"Lucky Potion","type":"timed","seconds":60,"luckAdd":1.0,"speedAdd":0},
  {"id":"PotionOfBound","name":"Potion of Bound","type":"next","seconds":0,"nextRollLuckAdd":50000,"speedAdd":0}
]
          </div>
          <div style="margin-top:10px">
            <b>type</b>: "timed" (seconds), "next" (one roll), "rolls" (charges).
          </div>
        </div>
        <textarea id="potionJson" class="input" style="height:260px; margin-top:12px; font-family: ui-monospace, monospace;"></textarea>
        <div class="row wrap" style="margin-top:10px">
          <button class="btn" id="btnLoadPotionsFromJson">Load Potions</button>
          <button class="btn ghost" id="btnCopyPotionsJson">Copy Current</button>
          <button class="btn danger" id="btnRestoreDefaultPotions">Restore Defaults</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* ============================================================
   SOLS RNG OFFLINE MOCK — FULL SYSTEMS + EASY EDIT ARRAYS
   - Rolling
   - Aura storage + inventory
   - Item storage (potions/items)
   - Potions + buffs stacking (timed, next-roll, roll-charges)
   - Luck + roll speed math
   - Auto roll + quick roll
   - Biome + day/night selectors
   - Start menu stats
   - Data-driven (edit AURAS / POTIONS / GAUNTLETS quickly)
============================================================ */

/* ===================== VERSION ===================== */
const VERSION = "v0.1";

/* ===================== DEFAULT DATA ===================== */
/* Edit AURAS here. rarity is N in 1/N. */
const DEFAULT_AURAS = [
  // Transcendent (from your screenshot + corrected luminosity)
  { name:"Nyctophobia", rarity:1011111010, class:"Transcendent", biome:"Limbo", nativeRarity:null, tags:["Transcendent","Biome"] },
  { name:"Pixelation", rarity:1073741824, class:"Transcendent", biome:"Cyberspace", nativeRarity:536870912, tags:["Transcendent","Biome"] },
  { name:"Luminosity", rarity:1200000000, class:"Transcendent", biome:"", nativeRarity:null, tags:["Transcendent","Global"] },
  { name:"Breakthrough", rarity:1999999999, class:"Transcendent", biome:"", nativeRarity:null, tags:["Transcendent","Global","NOT during NULL"] },
  { name:"Equinox", rarity:2500000000, class:"Transcendent", biome:"", nativeRarity:null, tags:["Transcendent","Global"] },

  // Glorious-ish (examples from screenshot; add the rest whenever)
  { name:"Chromatic : Genesis", rarity: 99999999, class:"Glorious", biome:"", nativeRarity:null, tags:["Global"] },
  { name:"Starscourge : Radiant", rarity:100000000, class:"Glorious", biome:"Starfall", nativeRarity:20000000, tags:["Biome"] },
  { name:"Spectraflow", rarity:100000000, class:"Glorious", biome:"", nativeRarity:null, tags:["Global"] },
  { name:"Overture", rarity:150000000, class:"Glorious", biome:"", nativeRarity:null, tags:["Global"] },
  { name:"Symphony", rarity:175000000, class:"Glorious", biome:"", nativeRarity:null, tags:["Global"] },
  { name:"Twilight : Withering Grace", rarity:180000000, class:"Glorious", biome:"Night", nativeRarity:18000000, tags:["Nighttime"] },
  { name:"Felled", rarity:180000000, class:"Glorious", biome:"", nativeRarity:null, tags:["Global"] },
  { name:"Impeached", rarity:200000000, class:"Glorious", biome:"Corruption", nativeRarity:40000000, tags:["Biome"] },
  { name:"Lumenpool", rarity:220000000, class:"Glorious", biome:"Rainy", nativeRarity:55000000, tags:["Biome"] },
  { name:"Hyper-Volt : Ever-Storm", rarity:225000000, class:"Glorious", biome:"", nativeRarity:null, tags:["Global"] },
  { name:"Astral : Zodiac", rarity:267200000, class:"Glorious", biome:"Starfall", nativeRarity:53440000, tags:["Biome"] },
  { name:"Prophecy", rarity:275649430, class:"Glorious", biome:"Heaven", nativeRarity:55129886, tags:["Biome"] },

  // A few more from screenshot set
  { name:"Exotic : Void", rarity:299999999, class:"Glorious", biome:"", nativeRarity:null, tags:["Global"] },
  { name:"Overture : History", rarity:300000000, class:"Glorious", biome:"", nativeRarity:null, tags:["Global"] },
  { name:"Bloodlust", rarity:300000000, class:"Glorious", biome:"Hell", nativeRarity:50000000, tags:["Biome"] },
  { name:"Maelstrom", rarity:309999999, class:"Glorious", biome:"Windy", nativeRarity:103333333, tags:["Biome"] },
  { name:"Perpetual", rarity:315000000, class:"Glorious", biome:"", nativeRarity:null, tags:["Global"] },
  { name:"Lotusfall", rarity:320000000, class:"Glorious", biome:"", nativeRarity:null, tags:["Global"] },
  { name:"Jazz : Orchestra", rarity:336870912, class:"Glorious", biome:"", nativeRarity:null, tags:["Global"] },
  { name:"Archangel", rarity:350000000, class:"Glorious", biome:"Heaven", nativeRarity:70000000, tags:["Biome"] },
  { name:"Atlas", rarity:360000000, class:"Glorious", biome:"Sandstorm", nativeRarity:90000000, tags:["Biome"] },
  { name:"Flora : Evergreen", rarity:370073730, class:"Glorious", biome:"", nativeRarity:null, tags:["Global"] },
  { name:"Chillsear", rarity:375000000, class:"Glorious", biome:"Snowy", nativeRarity:125000000, tags:["Biome"] },
  { name:"Abyssal Hunter", rarity:400000000, class:"Glorious", biome:"Rainy", nativeRarity:100000000, tags:["Biome"] },

  // A few “common-ish” fillers so rolling isn’t only ultra rares (edit/replace with real list)
  { name:"Common", rarity:2, class:"Basic", biome:"", nativeRarity:null, tags:["Basic"] },
  { name:"Uncommon", rarity:4, class:"Basic", biome:"", nativeRarity:null, tags:["Basic"] },
  { name:"Rare", rarity:16, class:"Basic", biome:"", nativeRarity:null, tags:["Basic"] },
  { name:"Divinus", rarity:32, class:"Basic", biome:"Heaven", nativeRarity:6, tags:["Biome"] },
  { name:"Forbidden", rarity:403, class:"Basic", biome:"Cyberspace", nativeRarity:202, tags:["Biome"] },
];

/* Potions/items: data-driven */
const DEFAULT_POTIONS = [
  // Quick tip: luckAdd = +0.25 means +25% luck (adds into multiplier). speedAdd similar.
  { id:"LuckyPotion", name:"Lucky Potion", type:"timed", seconds:60,  luckAdd:1.00,  speedAdd:0,      nextRollLuckAdd:0,  negateAllBuffs:false, rollCharges:0, desc:"+25% (+1) Luck • 60s" },
  { id:"SpeedPotion", name:"Speed Potion", type:"timed", seconds:60,  luckAdd:0,     speedAdd:0.10,  nextRollLuckAdd:0,  negateAllBuffs:false, rollCharges:0, desc:"+10% Roll Speed • 60s" },

  { id:"LuckyPotionL", name:"Lucky Potion L", type:"timed", seconds:300, luckAdd:0.25, speedAdd:0, nextRollLuckAdd:0, negateAllBuffs:false, rollCharges:0, desc:"+25% (+0.25) Luck • 300s" },
  { id:"LuckyPotionXL", name:"Lucky Potion XL", type:"timed", seconds:600, luckAdd:0.25, speedAdd:0, nextRollLuckAdd:0, negateAllBuffs:false, rollCharges:0, desc:"+25% (+0.25) Luck • 600s" },
  { id:"SpeedPotionL", name:"Speed Potion L", type:"timed", seconds:300, luckAdd:0, speedAdd:0.10, nextRollLuckAdd:0, negateAllBuffs:false, rollCharges:0, desc:"+10% Roll Speed • 300s" },
  { id:"SpeedPotionXL", name:"Speed Potion XL", type:"timed", seconds:600, luckAdd:0, speedAdd:0.10, nextRollLuckAdd:0, negateAllBuffs:false, rollCharges:0, desc:"+10% Roll Speed • 600s" },

  { id:"FortuneSpoid1", name:"Fortune Spoid I", type:"timed", seconds:60, luckAdd:0.50, speedAdd:0, nextRollLuckAdd:0, negateAllBuffs:false, rollCharges:0, desc:"+50% (+0.5) Luck • 60s" },
  { id:"FortuneSpoid2", name:"Fortune Spoid II", type:"timed", seconds:60, luckAdd:0.75, speedAdd:0, nextRollLuckAdd:0, negateAllBuffs:false, rollCharges:0, desc:"+75% (+0.75) Luck • 60s" },
  { id:"FortuneSpoid3", name:"Fortune Spoid III", type:"timed", seconds:60, luckAdd:1.00, speedAdd:0, nextRollLuckAdd:0, negateAllBuffs:false, rollCharges:0, desc:"+100% (+1.0) Luck • 60s" },

  { id:"FortunePotionI", name:"Fortune Potion I", type:"timed", seconds:300, luckAdd:0.50, speedAdd:0, nextRollLuckAdd:0, negateAllBuffs:false, rollCharges:0, desc:"+50% (+0.5) Luck • 300s" },
  { id:"FortunePotionII", name:"Fortune Potion II", type:"timed", seconds:300, luckAdd:0.75, speedAdd:0, nextRollLuckAdd:0, negateAllBuffs:false, rollCharges:0, desc:"+75% (+0.75) Luck • 300s" },
  { id:"FortunePotionIII", name:"Fortune Potion III", type:"timed", seconds:300, luckAdd:1.00, speedAdd:0, nextRollLuckAdd:0, negateAllBuffs:false, rollCharges:0, desc:"+100% (+1.0) Luck • 300s" },

  { id:"HugeFortuneI", name:"Huge Fortune Potion I", type:"timed", seconds:3600, luckAdd:0.50, speedAdd:0, nextRollLuckAdd:0, negateAllBuffs:false, rollCharges:0, desc:"+50% (+0.5) Luck • 3600s" },

  { id:"HasteI", name:"Haste Potion I", type:"timed", seconds:300, luckAdd:0, speedAdd:0.20, nextRollLuckAdd:0, negateAllBuffs:false, rollCharges:0, desc:"+20% Roll Speed • 300s" },
  { id:"HasteII", name:"Haste Potion II", type:"timed", seconds:300, luckAdd:0, speedAdd:0.25, nextRollLuckAdd:0, negateAllBuffs:false, rollCharges:0, desc:"+25% Roll Speed • 300s" },
  { id:"HasteIII", name:"Haste Potion III", type:"timed", seconds:300, luckAdd:0, speedAdd:0.30, nextRollLuckAdd:0, negateAllBuffs:false, rollCharges:0, desc:"+30% Roll Speed • 300s" },

  { id:"PotionOfBound", name:"Potion of Bound", type:"next", seconds:0, luckAdd:0, speedAdd:0, nextRollLuckAdd:50000, negateAllBuffs:false, rollCharges:0, desc:"+5,000,000% (+50,000) Luck next roll" },
  { id:"HeavenlyPotion", name:"Heavenly Potion", type:"next", seconds:0, luckAdd:0, speedAdd:0, nextRollLuckAdd:150000, negateAllBuffs:false, rollCharges:0, desc:"+15,000,000% (+150,000) Luck next roll" },
  { id:"GodlikePotion", name:"Godlike Potion", type:"next", seconds:0, luckAdd:0, speedAdd:0, nextRollLuckAdd:400000, negateAllBuffs:false, rollCharges:0, desc:"+40,000,000% (+400,000) Luck next roll" },

  { id:"MixedPotion", name:"Mixed Potion", type:"timed", seconds:180, luckAdd:0.25, speedAdd:0.10, nextRollLuckAdd:0, negateAllBuffs:false, rollCharges:0, desc:"+25% Luck & +10% Speed • 180s" },

  { id:"OblivionPotion", name:"Oblivion Potion", type:"next", seconds:0, luckAdd:0, speedAdd:0, nextRollLuckAdd:600000, negateAllBuffs:true, rollCharges:0, desc:"+60,000,000% (+600,000) next roll • negates buffs (except base toggles)" },

  { id:"WarpPotion", name:"Warp Potion", type:"rolls", seconds:0, luckAdd:0, speedAdd:10.00, nextRollLuckAdd:0, negateAllBuffs:false, rollCharges:2000, desc:"+1000% Roll Speed for 2000 rolls" },
  { id:"TranscendentPotion", name:"Transcendent Potion", type:"rolls", seconds:0, luckAdd:0, speedAdd:10.00, nextRollLuckAdd:0, negateAllBuffs:false, rollCharges:20000, desc:"+1000% Roll Speed for 20000 rolls" },

  { id:"GladiatorPotion", name:"Gladiator Potion", type:"timed", seconds:999999, luckAdd:1.00, speedAdd:0, nextRollLuckAdd:0, negateAllBuffs:false, rollCharges:0, desc:"+100% Luck (quest buff style)" },
  { id:"RaidPotion", name:"Raid Potion", type:"timed", seconds:999999, luckAdd:1.00, speedAdd:0, nextRollLuckAdd:0, negateAllBuffs:false, rollCharges:0, desc:"+100% Luck (season pass style)" },

  { id:"PotionOfDune", name:"Potion of the Dune", type:"next", seconds:0, luckAdd:0, speedAdd:0, nextRollLuckAdd:10000, negateAllBuffs:false, rollCharges:0, desc:"+1,000,000% (+10,000) next roll" },

  // Strange potions (random blessing/curse)
  {
    id:"StrangeI", name:"Strange Potion I", type:"random", seconds:300,
    pool:[
      { label:"The Chosen", luckAdd:1.50, speedAdd:0.30 },
      { label:"The Power I", luckAdd:1.50, speedAdd:0.00 },
      { label:"The Knowledge I", luckAdd:0.00, speedAdd:0.30 },
      { label:"The Wrath I", luckAdd:-0.50, speedAdd:0.00 },
      { label:"The Sloth I", luckAdd:0.00, speedAdd:-0.15 },
    ],
    desc:"Random blessing/curse • 300s"
  },
  {
    id:"StrangeII", name:"Strange Potion II", type:"random", seconds:600,
    pool:[
      { label:"GODLIKE", luckAdd:2.50, speedAdd:0.40 },
      { label:"The Power II", luckAdd:2.50, speedAdd:0.00 },
      { label:"The Knowledge II", luckAdd:0.00, speedAdd:0.40 },
      { label:"The Wrath II", luckAdd:-1.00, speedAdd:0.00 },
      { label:"The Sloth II", luckAdd:0.00, speedAdd:-0.25 },
    ],
    desc:"Random blessing/curse • 600s"
  },
];

/* Gauntlets (example gear system). Equip toggles add permanent stats. */
const DEFAULT_GAUNTLETS = [
  { id:"None", name:"No Gauntlet", luckAdd:0, speedAdd:0, desc:"No bonus" },
  { id:"LuckyGauntlet", name:"Lucky Gauntlet", luckAdd:0.25, speedAdd:0, desc:"+25% Luck (example)" },
  { id:"SwiftGauntlet", name:"Swift Gauntlet", luckAdd:0, speedAdd:0.20, desc:"+20% Roll Speed (example)" },
  { id:"BlessedGauntlet", name:"Blessed Gauntlet", luckAdd:0.50, speedAdd:0.10, desc:"+50% Luck & +10% Speed (example)" },
];

/* ===================== STATE ===================== */
let AURAS = loadLS("AURAS", DEFAULT_AURAS);
let POTIONS = loadLS("POTIONS", DEFAULT_POTIONS);
let GAUNTLETS = loadLS("GAUNTLETS", DEFAULT_GAUNTLETS);

let state = loadLS("SAVE_STATE", {
  version: VERSION,
  theme: "dark",
  biome: "",
  dayNight: "Day",
  // Inventory:
  items: {}, // potionId -> qty
  // Gear:
  equippedGauntletId: "None",
  vip: false,
  vipPlus: false,
  // Buffs:
  activeTimed: [],     // {id,name,endsAt, luckAdd, speedAdd, label?}
  activeRolls: [],     // {id,name, rollsLeft, luckAdd, speedAdd, label?}
  nextRollLuckAdd: 0,  // numeric additive
  // Aura logs:
  history: [],         // last rolled list (for right panel)
  auraInventory: [],   // full inventory log
  auraStorage: [],     // stored auras (your stash)
  // auto/quick:
  autoOn: false,
  quickOn: false,
  autoTarget: "Luminosity",
  autoStopN: 1000000,
  quickBatch: 10,
  quickInterval: 120
});

/* ===================== HELPERS ===================== */
function $(sel){ return document.querySelector(sel); }
function $all(sel){ return [...document.querySelectorAll(sel)]; }
function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }
function now(){ return Date.now(); }
function fmtN(n){
  if(!Number.isFinite(n)) return String(n);
  return Math.round(n).toLocaleString();
}
function fmtTime(ms){
  const s = Math.max(0, Math.ceil(ms/1000));
  const m = Math.floor(s/60);
  const r = s%60;
  if(m<=0) return `${r}s`;
  const h = Math.floor(m/60);
  const mm = m%60;
  if(h<=0) return `${m}m ${r}s`;
  return `${h}h ${mm}m`;
}
function loadLS(key, fallback){
  try{
    const raw = localStorage.getItem(key);
    if(!raw) return structuredClone(fallback);
    return JSON.parse(raw);
  }catch(e){
    return structuredClone(fallback);
  }
}
function saveLS(key, value){
  localStorage.setItem(key, JSON.stringify(value));
}
function saveAll(){
  saveLS("AURAS", AURAS);
  saveLS("POTIONS", POTIONS);
  saveLS("GAUNTLETS", GAUNTLETS);
  state.version = VERSION;
  saveLS("SAVE_STATE", state);
}

/* ===================== LUCK / SPEED CALC ===================== */
function getGauntlet(){
  return GAUNTLETS.find(g=>g.id===state.equippedGauntletId) || GAUNTLETS[0];
}

function purgeExpired(){
  const t = now();
  state.activeTimed = state.activeTimed.filter(b => b.endsAt > t);
  state.activeRolls = state.activeRolls.filter(b => b.rollsLeft > 0);
}

function calcStats(){
  purgeExpired();

  const baseLuck = 1.0;
  const baseSpeed = 1.0;

  const g = getGauntlet();

  const vipLuckMult = state.vip ? 0.25 : 0;      // easy to edit
  const vipPlusLuckMult = state.vipPlus ? 0.50 : 0;

  // Luck is multiplier-like: finalLuck = base * (1 + sum of luckAdd)
  // Speed is multiplier-like too.
  let luckAdds = [];
  let speedAdds = [];

  // Gear
  luckAdds.push({label:"Gauntlet", value:g.luckAdd||0});
  speedAdds.push({label:"Gauntlet", value:g.speedAdd||0});

  // VIP toggles
  if(state.vip) luckAdds.push({label:"VIP", value:vipLuckMult});
  if(state.vipPlus) luckAdds.push({label:"VIP+", value:vipPlusLuckMult});

  // Timed buffs
  for(const b of state.activeTimed){
    luckAdds.push({label:b.label || b.name, value:b.luckAdd||0});
    speedAdds.push({label:b.label || b.name, value:b.speedAdd||0});
  }

  // Roll-charge buffs
  for(const b of state.activeRolls){
    luckAdds.push({label:`${b.label || b.name} (${b.rollsLeft} rolls)`, value:b.luckAdd||0});
    speedAdds.push({label:`${b.label || b.name} (${b.rollsLeft} rolls)`, value:b.speedAdd||0});
  }

  const luckSum = luckAdds.reduce((a,x)=>a+(x.value||0), 0);
  const speedSum = speedAdds.reduce((a,x)=>a+(x.value||0), 0);

  const finalLuck = Math.max(0.05, baseLuck * (1 + luckSum));
  const finalSpeed = Math.max(0.05, baseSpeed * (1 + speedSum));

  const nextRollLuck = Math.max(0, state.nextRollLuckAdd || 0);

  return { finalLuck, finalSpeed, nextRollLuck, baseLuck, baseSpeed, luckAdds, speedAdds };
}

/* ===================== BIOME / NATIVE RARITY ===================== */
function auraEffectiveN(aura, finalLuck){
  // Base N
  let N = aura.rarity;

  // Native biome chance (if biome matches)
  if(aura.nativeRarity && aura.biome){
    const biome = state.biome || "";
    const dayNight = state.dayNight || "Day";

    // Some entries use biome like "Night" or "Day" (we treat those as day/night)
    const matchesBiome =
      aura.biome === biome ||
      (aura.biome === "Night" && dayNight === "Night") ||
      (aura.biome === "Day" && dayNight === "Day") ||
      (aura.biome === "Limbo" && biome === "Limbo");

    if(matchesBiome) N = aura.nativeRarity;
  }

  // Special: Breakthrough NOT during NULL (you told me this)
  if(aura.name === "Breakthrough" && (state.biome === "Null")){
    // effectively impossible here: set astronomically high
    N = 999999999999;
  }

  // Apply luck
  const eff = Math.max(1, Math.floor(N / finalLuck));
  return eff;
}

/* ===================== ROLLING ===================== */
function rollOnce({fast=false}={}){
  const stats = calcStats();

  // Build final luck for THIS roll (includes next-roll add)
  const rollLuck = Math.max(0.05, stats.finalLuck + stats.nextRollLuck);

  // If any roll-charge buffs exist, decrement after roll
  for(const b of state.activeRolls){
    b.rollsLeft -= 1;
  }

  // Consume next-roll luck after this roll
  state.nextRollLuckAdd = 0;

  // Weighted selection:
  // Compute p_i = 1/effN, normalize to sum, then pick.
  // This is not the exact Roblox system, but it’s consistent + editable.
  const weights = [];
  let sum = 0;

  for(const a of AURAS){
    const effN = auraEffectiveN(a, rollLuck);
    const p = 1 / effN;
    sum += p;
    weights.push({a, effN, p});
  }

  // Safety
  if(sum <= 0){
    return null;
  }

  let r = Math.random() * sum;
  let picked = weights[weights.length-1];
  for(const w of weights){
    r -= w.p;
    if(r <= 0){
      picked = w;
      break;
    }
  }

  const aura = picked.a;
  const effN = picked.effN;

  const ts = new Date();
  const entry = {
    name: aura.name,
    class: aura.class || "",
    baseN: aura.rarity,
    effN,
    biome: state.biome || "",
    dayNight: state.dayNight || "Day",
    time: ts.toISOString()
  };

  // History (right panel): keep last 30
  state.history.unshift(entry);
  state.history = state.history.slice(0, 30);

  // Aura inventory (full log): keep last 500
  state.auraInventory.unshift(entry);
  state.auraInventory = state.auraInventory.slice(0, 500);

  // Auto stop logic
  maybeStopAuto(entry);

  // Save + render
  saveAll();
  if(!fast){
    // tiny "impact" on roll button
    $("#btnRoll").animate([{transform:"scale(1)"},{transform:"scale(1.03)"},{transform:"scale(1)"}], {duration:120});
  }
  renderAll();
  return entry;
}

function maybeStopAuto(entry){
  if(!state.autoOn) return;

  const targetAura = AURAS.find(a=>a.name===state.autoTarget);
  if(targetAura){
    // stop if rolled aura is at least as rare (base rarity)
    if(entry.baseN >= targetAura.rarity){
      // Note: bigger N = rarer
      // so stop when rolledN >= targetN
      stopAuto();
      return;
    }
  }

  // stop if effective rarity meets threshold
  const stopN = Number(state.autoStopN) || 0;
  if(stopN > 0 && entry.effN >= stopN){
    stopAuto();
    return;
  }
}

/* ===================== POTION / BUFF USAGE ===================== */
function getPotion(id){
  return POTIONS.find(p=>p.id===id);
}
function addItem(id, qty){
  state.items[id] = (state.items[id] || 0) + qty;
  if(state.items[id] < 0) state.items[id] = 0;
}
function usePotion(id){
  const p = getPotion(id);
  if(!p) return;

  const have = state.items[id] || 0;
  if(have <= 0){
    alert("You don't have that item.");
    return;
  }

  // spend
  addItem(id, -1);

  // Oblivion: negate all buffs (timed + roll buffs), keep base toggles/gear
  if(p.negateAllBuffs){
    state.activeTimed = [];
    state.activeRolls = [];
  }

  // Random blessings/curse
  if(p.type === "random" && Array.isArray(p.pool) && p.pool.length){
    const pick = p.pool[Math.floor(Math.random()*p.pool.length)];
    state.activeTimed.push({
      id: p.id,
      name: p.name,
      label: `${p.name}: ${pick.label}`,
      luckAdd: pick.luckAdd || 0,
      speedAdd: pick.speedAdd || 0,
      endsAt: now() + (p.seconds||0)*1000
    });
    saveAll();
    renderAll();
    return;
  }

  // Next-roll
  if(p.type === "next"){
    state.nextRollLuckAdd += (p.nextRollLuckAdd || 0);
    saveAll();
    renderAll();
    return;
  }

  // Roll charges
  if(p.type === "rolls"){
    state.activeRolls.push({
      id: p.id,
      name: p.name,
      label: p.name,
      luckAdd: p.luckAdd || 0,
      speedAdd: p.speedAdd || 0,
      rollsLeft: p.rollCharges || 0
    });
    saveAll();
    renderAll();
    return;
  }

  // Timed
  if(p.type === "timed"){
    state.activeTimed.push({
      id: p.id,
      name: p.name,
      label: p.name,
      luckAdd: p.luckAdd || 0,
      speedAdd: p.speedAdd || 0,
      endsAt: now() + (p.seconds||0)*1000
    });
    saveAll();
    renderAll();
    return;
  }
}

/* ===================== AUTO / QUICK ===================== */
let autoTimer = null;
let quickTimer = null;

function startAuto(){
  if(state.autoOn) return;
  state.autoOn = true;
  saveAll();
  scheduleAutoTick();
  renderAll();
}
function stopAuto(){
  state.autoOn = false;
  if(autoTimer){ clearTimeout(autoTimer); autoTimer = null; }
  saveAll();
  renderAll();
}
function scheduleAutoTick(){
  if(!state.autoOn) return;

  const { finalSpeed } = calcStats();
  // base interval 900ms, faster with speed
  const base = 900;
  const interval = clamp(Math.floor(base / finalSpeed), 35, 2000);

  autoTimer = setTimeout(()=>{
    rollOnce({fast:true});
    scheduleAutoTick();
  }, interval);
}

function startQuick(){
  if(state.quickOn) return;
  state.quickOn = true;
  saveAll();
  scheduleQuickTick();
  renderAll();
}
function stopQuick(){
  state.quickOn = false;
  if(quickTimer){ clearTimeout(quickTimer); quickTimer = null; }
  saveAll();
  renderAll();
}
function scheduleQuickTick(){
  if(!state.quickOn) return;
  const batch = clamp(Number(state.quickBatch)||10, 1, 500);
  const interval = clamp(Number(state.quickInterval)||120, 10, 5000);

  quickTimer = setTimeout(()=>{
    for(let i=0;i<batch;i++){
      rollOnce({fast:true});
      if(!state.quickOn) break;
    }
    scheduleQuickTick();
  }, interval);
}

/* ===================== RENDERING ===================== */
function renderAll(){
  $("#versionText").textContent = VERSION;

  if(state.theme === "light"){
    document.body.classList.add("light");
  }else{
    document.body.classList.remove("light");
  }

  // selectors
  $("#biomeSelect").value = state.biome || "";
  $("#biomeLabel").textContent = state.biome || "None";
  $("#timeSelect").value = state.dayNight || "Day";
  $("#timeLabel").textContent = state.dayNight || "Day";

  // Stats
  const s = calcStats();
  $("#statLuck").textContent = `x${s.finalLuck.toFixed(2)}`;
  $("#statSpeed").textContent = `x${s.finalSpeed.toFixed(2)}`;
  $("#statNextLuck").textContent = `+${fmtN(s.nextRollLuckAdd)}`;

  $("#statLuckBreakdown").textContent = breakdownText("Luck", s.luckAdds);
  $("#statSpeedBreakdown").textContent = breakdownText("Speed", s.speedAdds);

  // Auto/Quick states
  $("#autoState").textContent = state.autoOn ? "ON" : "OFF";
  $("#quickState").textContent = state.quickOn ? "ON" : "OFF";

  // Buttons labels
  $("#btnAuto").textContent = state.autoOn ? "Stop Auto" : "Auto Roll";
  $("#btnQuick").textContent = state.quickOn ? "Stop Quick" : "Quick Roll";

  // Buff strip
  renderBuffStrip();

  // Right history list
  renderHistory();

  // Storage & inventory lists
  renderStorageLists();

  // Left inventory: gauntlets + potions
  renderLeftInventory();

  // Multi modal preview lists
  renderPreviewSelects();

  // Start menu values
  renderStartMenu();
}

function breakdownText(kind, adds){
  const sum = adds.reduce((a,x)=>a+(x.value||0),0);
  const sign = sum >= 0 ? "+" : "";
  return `${kind} adds: ${sign}${sum.toFixed(2)}`;
}

function renderBuffStrip(){
  const strip = $("#buffStrip");
  strip.innerHTML = "";

  const s = calcStats();
  // Show: gauntlet, VIP, VIP+, timed buffs, roll buffs, next-roll
  // Right-to-left order already handled by flex-end in CSS.
  const boxes = [];

  // Base toggles
  const g = getGauntlet();
  boxes.push(makeBuffBox({
    title:`Gauntlet: ${g.name}`,
    tag:"Gear",
    cls:"on",
    tipLines:[
      `Luck add: <b>${(g.luckAdd||0).toFixed(2)}</b>`,
      `Speed add: <b>${(g.speedAdd||0).toFixed(2)}</b>`
    ]
  }));

  boxes.push(makeBuffBox({
    title:`VIP`,
    tag: state.vip ? "ON" : "OFF",
    cls: state.vip ? "good" : "",
    tipLines:[`Luck add: <b>${state.vip ? "0.25" : "0.00"}</b>`]
  }));

  boxes.push(makeBuffBox({
    title:`VIP+`,
    tag: state.vipPlus ? "ON" : "OFF",
    cls: state.vipPlus ? "good" : "",
    tipLines:[`Luck add: <b>${state.vipPlus ? "0.50" : "0.00"}</b>`]
  }));

  // Next roll
  boxes.push(makeBuffBox({
    title:"Next Roll",
    tag:`+${fmtN(s.nextRollLuckAdd)}`,
    cls: s.nextRollLuckAdd > 0 ? "warn" : "",
    tipLines:[`Adds <b>${fmtN(s.nextRollLuckAdd)}</b> luck to your next roll only.`]
  }));

  // Roll buffs
  for(const b of state.activeRolls){
    boxes.push(makeBuffBox({
      title:b.label || b.name,
      tag:`${b.rollsLeft} rolls`,
      cls:"on",
      tipLines:[
        `Luck add: <b>${(b.luckAdd||0).toFixed(2)}</b>`,
        `Speed add: <b>${(b.speedAdd||0).toFixed(2)}</b>`
      ]
    }));
  }

  // Timed buffs
  for(const b of state.activeTimed){
    const left = b.endsAt - now();
    boxes.push(makeBuffBox({
      title:b.label || b.name,
      tag: fmtTime(left),
      cls: (b.luckAdd||0) < 0 || (b.speedAdd||0) < 0 ? "bad" : "on",
      tipLines:[
        `Luck add: <b>${(b.luckAdd||0).toFixed(2)}</b>`,
        `Speed add: <b>${(b.speedAdd||0).toFixed(2)}</b>`,
        `Ends in <b>${fmtTime(left)}</b>`
      ]
    }));
  }

  for(const el of boxes.reverse()){
    strip.appendChild(el);
  }
}

function makeBuffBox({title, tag, cls="", tipLines=[]}){
  const box = document.createElement("div");
  box.className = `buffBox hasTip ${cls}`.trim();
  box.innerHTML = `
    <span class="t">${escapeHtml(title)}</span>
    <span class="muted">${escapeHtml(tag)}</span>
    <div class="tip">
      <div class="tTitle">${escapeHtml(title)}</div>
      ${tipLines.map(t=>`<div class="tRow">${t}</div>`).join("")}
    </div>
  `;
  return box;
}

function renderHistory(){
  const list = $("#historyList");
  list.innerHTML = "";

  if(!state.history.length){
    list.innerHTML = `<div class="tiny">No rolls yet. Hit <b>ROLL</b>.</div>`;
    return;
  }

  for(const h of state.history){
    const div = document.createElement("div");
    div.className = "historyItem";
    const date = new Date(h.time);
    div.innerHTML = `
      <div class="top">
        <div>
          <div class="name">${escapeHtml(h.name)}</div>
          <div class="small">
            Base: <b>1/${fmtN(h.baseN)}</b><br/>
            Effective: <b>1/${fmtN(h.effN)}</b><br/>
            Biome: <b>${escapeHtml(h.biome||"None")}</b> • ${escapeHtml(h.dayNight||"Day")}
          </div>
          <div class="pill" style="margin-top:8px">
            <span>Class</span> <strong>${escapeHtml(h.class||"")}</strong>
          </div>
        </div>
        <div class="time">${date.toLocaleTimeString()}</div>
      </div>
      <div class="row wrap" style="margin-top:10px">
        <button class="btn ghost small" data-store="${escapeHtml(h.time)}">Store</button>
      </div>
    `;
    list.appendChild(div);
  }

  // store handlers
  $all("[data-store]").forEach(btn=>{
    btn.onclick = ()=>{
      const key = btn.getAttribute("data-store");
      const entry = state.history.find(x=>x.time===key);
      if(entry){
        state.auraStorage.unshift(entry);
        state.auraStorage = state.auraStorage.slice(0, 300);
        saveAll();
        renderAll();
      }
    };
  });
}

function renderStorageLists(){
  // Aura storage
  const search = ($("#storageSearch").value || "").toLowerCase().trim();
  const storageList = $("#storageList");
  storageList.innerHTML = "";
  const filteredStorage = state.auraStorage.filter(a => !search || a.name.toLowerCase().includes(search));
  $("#storageCount").textContent = String(state.auraStorage.length);

  if(!filteredStorage.length){
    storageList.innerHTML = `<div class="tiny">No stored auras.</div>`;
  }else{
    for(const a of filteredStorage.slice(0, 200)){
      const row = document.createElement("div");
      row.className = "miniItem";
      row.innerHTML = `
        <div class="lefty">
          <div class="n">${escapeHtml(a.name)}</div>
          <div class="m">1/${fmtN(a.baseN)} • eff 1/${fmtN(a.effN)}</div>
        </div>
        <div class="actions">
          <div class="qty">${escapeHtml(a.class||"")}</div>
          <button class="btn danger small" data-delstore="${escapeHtml(a.time)}">X</button>
        </div>
      `;
      storageList.appendChild(row);
    }
  }

  $all("[data-delstore]").forEach(b=>{
    b.onclick = ()=>{
      const key = b.getAttribute("data-delstore");
      state.auraStorage = state.auraStorage.filter(x=>x.time!==key);
      saveAll();
      renderAll();
    };
  });

  // Aura inventory (small)
  const invSearch = ($("#invSearch").value || "").toLowerCase().trim();
  const invList = $("#invList");
  invList.innerHTML = "";
  const invFiltered = state.auraInventory.filter(a => !invSearch || a.name.toLowerCase().includes(invSearch));
  $("#invCount").textContent = String(state.auraInventory.length);

  if(!invFiltered.length){
    invList.innerHTML = `<div class="tiny">No auras yet.</div>`;
  }else{
    for(const a of invFiltered.slice(0, 200)){
      const row = document.createElement("div");
      row.className = "miniItem";
      row.innerHTML = `
        <div class="lefty">
          <div class="n">${escapeHtml(a.name)}</div>
          <div class="m">1/${fmtN(a.baseN)} • eff 1/${fmtN(a.effN)}</div>
        </div>
        <div class="qty">${escapeHtml(a.class||"")}</div>
      `;
      invList.appendChild(row);
    }
  }

  // Full inventory tab
  const fullSearch = ($("#fullInvSearch").value || "").toLowerCase().trim();
  const sort = $("#fullInvSort").value || "time_desc";
  let listData = state.auraInventory.slice();

  if(fullSearch){
    listData = listData.filter(a => a.name.toLowerCase().includes(fullSearch));
  }

  listData.sort((a,b)=>{
    if(sort==="time_desc") return b.time.localeCompare(a.time);
    if(sort==="time_asc") return a.time.localeCompare(b.time);
    if(sort==="rarity_desc") return (b.baseN - a.baseN);
    if(sort==="rarity_asc") return (a.baseN - b.baseN);
    if(sort==="name_asc") return a.name.localeCompare(b.name);
    return 0;
  });

  const full = $("#fullInvList");
  full.innerHTML = "";
  if(!listData.length){
    full.innerHTML = `<div class="tiny">No matches.</div>`;
  }else{
    for(const a of listData.slice(0, 400)){
      const row = document.createElement("div");
      row.className = "miniItem";
      row.innerHTML = `
        <div class="lefty">
          <div class="n">${escapeHtml(a.name)}</div>
          <div class="m">Base 1/${fmtN(a.baseN)} • Eff 1/${fmtN(a.effN)} • ${escapeHtml(a.biome||"None")} • ${escapeHtml(a.dayNight||"Day")}</div>
        </div>
        <div class="qty">${escapeHtml(a.class||"")}</div>
      `;
      full.appendChild(row);
    }
  }
}

function renderLeftInventory(){
  // tabs already handled by visibility; just refresh lists
  const gauntletsDiv = $("#invGauntlets");
  const potionsDiv = $("#invPotions");

  // Gauntlets
  gauntletsDiv.innerHTML = "";
  const equipped = getGauntlet();

  // VIP toggles card
  const vipCard = document.createElement("div");
  vipCard.className = "card";
  vipCard.innerHTML = `
    <div class="cardHeader">
      <div class="cardTitle">
        <div class="name">VIP Toggles</div>
        <div class="meta">Permanent multipliers (kept even after Oblivion)</div>
      </div>
      <span class="badge ${state.vip || state.vipPlus ? "good":""}">Base</span>
    </div>
    <div class="row wrap" style="margin-top:10px">
      <button class="btn ${state.vip ? "secondary": "ghost"}" id="btnVip">${state.vip ? "VIP: ON" : "VIP: OFF"}</button>
      <button class="btn ${state.vipPlus ? "secondary": "ghost"}" id="btnVipPlus">${state.vipPlus ? "VIP+: ON" : "VIP+: OFF"}</button>
    </div>
    <div class="hint" style="margin-top:10px">
      VIP adds +0.25 luck. VIP+ adds +0.50 luck. Edit these in <span class="mono">calcStats()</span>.
    </div>
  `;
  gauntletsDiv.appendChild(vipCard);

  // Equip gauntlet card
  for(const g of GAUNTLETS){
    const c = document.createElement("div");
    c.className = "card";
    const isEq = (g.id === equipped.id);
    c.innerHTML = `
      <div class="cardHeader">
        <div class="cardTitle">
          <div class="name">${escapeHtml(g.name)}</div>
          <div class="meta">${escapeHtml(g.desc || "")}</div>
        </div>
        <span class="badge ${isEq ? "good" : ""}">${isEq ? "Equipped" : "Gauntlet"}</span>
      </div>
      <div class="kv">
        <div>Luck add</div><b>${(g.luckAdd||0).toFixed(2)}</b>
        <div>Speed add</div><b>${(g.speedAdd||0).toFixed(2)}</b>
      </div>
      <div class="row wrap" style="margin-top:10px">
        <button class="btn ${isEq ? "ghost" : "secondary"}" data-equip="${escapeHtml(g.id)}">${isEq ? "Equipped" : "Equip"}</button>
      </div>
    `;
    gauntletsDiv.appendChild(c);
  }

  // Potions + items
  potionsDiv.innerHTML = "";
  const pHeader = document.createElement("div");
  pHeader.className = "card";
  pHeader.innerHTML = `
    <div class="cardHeader">
      <div class="cardTitle">
        <div class="name">Potions & Items</div>
        <div class="meta">Use them to add buffs. Hover buffs in main screen to see your luck.</div>
      </div>
      <span class="badge warn">${Object.values(state.items).reduce((a,n)=>a+n,0)} items</span>
    </div>
    <div class="hint" style="margin-top:10px">
      Add more items by editing <span class="mono">POTIONS</span>. Each one needs an <span class="mono">id</span>.
    </div>
  `;
  potionsDiv.appendChild(pHeader);

  // Item list
  for(const p of POTIONS){
    const qty = state.items[p.id] || 0;
    const c = document.createElement("div");
    c.className = "card";
    const badgeClass = qty>0 ? "good" : "";
    c.innerHTML = `
      <div class="cardHeader">
        <div class="cardTitle">
          <div class="name">${escapeHtml(p.name)}</div>
          <div class="meta">${escapeHtml(p.desc || "")}</div>
        </div>
        <span class="badge ${badgeClass}">x${qty}</span>
      </div>
      <div class="kv">
        <div>Type</div><b>${escapeHtml(p.type || "")}</b>
        <div>Luck add</div><b>${(p.luckAdd||0).toFixed(2)}</b>
        <div>Speed add</div><b>${(p.speedAdd||0).toFixed(2)}</b>
        <div>Duration</div><b>${p.type==="timed" ? (p.seconds+"s") : (p.type==="rolls" ? (p.rollCharges+" rolls") : (p.type==="next" ? "Next roll" : (p.type==="random" ? (p.seconds+"s") : "-")))}</b>
      </div>
      <div class="row wrap" style="margin-top:10px">
        <button class="btn ${qty>0 ? "secondary" : "ghost"}" data-use="${escapeHtml(p.id)}">Use</button>
        <button class="btn ghost small" data-add="${escapeHtml(p.id)}">+1</button>
        <button class="btn ghost small" data-add10="${escapeHtml(p.id)}">+10</button>
      </div>
    `;
    potionsDiv.appendChild(c);
  }

  // Handlers
  $("#btnVip").onclick = ()=>{ state.vip = !state.vip; saveAll(); renderAll(); };
  $("#btnVipPlus").onclick = ()=>{ state.vipPlus = !state.vipPlus; saveAll(); renderAll(); };

  $all("[data-equip]").forEach(b=>{
    b.onclick = ()=>{
      state.equippedGauntletId = b.getAttribute("data-equip");
      saveAll();
      renderAll();
    };
  });

  $all("[data-use]").forEach(b=>{
    b.onclick = ()=> usePotion(b.getAttribute("data-use"));
  });
  $all("[data-add]").forEach(b=>{
    b.onclick = ()=>{
      addItem(b.getAttribute("data-add"), 1);
      saveAll(); renderAll();
    };
  });
  $all("[data-add10]").forEach(b=>{
    b.onclick = ()=>{
      addItem(b.getAttribute("data-add10"), 10);
      saveAll(); renderAll();
    };
  });
}

function renderPreviewSelects(){
  const sel = $("#previewAura");
  const autoTarget = $("#autoTarget");
  sel.innerHTML = "";
  autoTarget.innerHTML = "";
  for(const a of AURAS.slice().sort((x,y)=>y.rarity-x.rarity)){
    const opt1 = document.createElement("option");
    opt1.value = a.name;
    opt1.textContent = `${a.name} (1/${fmtN(a.rarity)})`;
    sel.appendChild(opt1);

    const opt2 = document.createElement("option");
    opt2.value = a.name;
    opt2.textContent = `${a.name} (1/${fmtN(a.rarity)})`;
    autoTarget.appendChild(opt2);
  }
  if(!sel.value) sel.value = state.autoTarget || (AURAS[0]?.name||"");
  if(!autoTarget.value) autoTarget.value = state.autoTarget || (AURAS[0]?.name||"");
  autoTarget.value = state.autoTarget || autoTarget.value;

  $("#autoStopN").value = state.autoStopN || 1000000;
  $("#quickBatch").value = state.quickBatch || 10;
  $("#quickInterval").value = state.quickInterval || 120;

  renderPreviewKv();
}

function renderPreviewKv(){
  const auraName = $("#previewAura").value;
  const aura = AURAS.find(a=>a.name===auraName) || AURAS[0];
  const { finalLuck, nextRollLuckAdd } = calcStats();
  const rollLuck = finalLuck + nextRollLuckAdd;

  const baseN = aura.rarity;
  const effN = auraEffectiveN(aura, rollLuck);

  const kv = $("#previewKv");
  kv.innerHTML = `
    <div>Selected</div><b>${escapeHtml(aura.name)}</b>
    <div>Base</div><b>1/${fmtN(baseN)}</b>
    <div>Effective (with next-roll)</div><b>1/${fmtN(effN)}</b>
    <div>Biome</div><b>${escapeHtml(state.biome||"None")}</b>
    <div>Day/Night</div><b>${escapeHtml(state.dayNight||"Day")}</b>
  `;
}

function renderStartMenu(){
  const s = calcStats();
  $("#menuLuckBadge").textContent = `x${s.finalLuck.toFixed(2)}`;
  $("#menuSpeedBadge").textContent = `x${s.finalSpeed.toFixed(2)}`;

  const luckKv = $("#menuLuckBreakdown");
  luckKv.innerHTML = "";
  for(const x of s.luckAdds){
    luckKv.innerHTML += `<div>${escapeHtml(x.label)}</div><b>${(x.value||0).toFixed(2)}</b>`;
  }
  const speedKv = $("#menuSpeedBreakdown");
  speedKv.innerHTML = "";
  for(const x of s.speedAdds){
    speedKv.innerHTML += `<div>${escapeHtml(x.label)}</div><b>${(x.value||0).toFixed(2)}</b>`;
  }
}

/* ===================== UI EVENTS ===================== */
function initUI(){
  $("#btnLight").onclick = ()=>{
    state.theme = (state.theme === "light") ? "dark" : "light";
    saveAll();
    renderAll();
  };

  // top tabs
  $all("[data-toptab]").forEach(t=>{
    t.onclick = ()=>{
      $all("[data-toptab]").forEach(x=>x.classList.remove("active"));
      t.classList.add("active");
      const key = t.getAttribute("data-toptab");
      $("#topTabStorage").style.display = (key==="storage") ? "" : "none";
      $("#topTabInventory").style.display = (key==="inventory") ? "" : "none";
      $("#topTabEdit").style.display = (key==="edit") ? "" : "none";
    };
  });

  // left inventory tabs
  $all("[data-invtab]").forEach(t=>{
    t.onclick = ()=>{
      $all("[data-invtab]").forEach(x=>x.classList.remove("active"));
      t.classList.add("active");
      const key = t.getAttribute("data-invtab");
      $("#invGauntlets").style.display = (key==="gauntlets") ? "" : "none";
      $("#invPotions").style.display = (key==="potions") ? "" : "none";
    };
  });

  // Search inputs
  $("#storageSearch").addEventListener("input", renderStorageLists);
  $("#invSearch").addEventListener("input", renderStorageLists);
  $("#fullInvSearch").addEventListener("input", renderStorageLists);
  $("#fullInvSort").addEventListener("change", renderStorageLists);

  // Biome / time
  $("#biomeSelect").addEventListener("change", ()=>{
    state.biome = $("#biomeSelect").value;
    saveAll();
    renderAll();
  });
  $("#timeSelect").addEventListener("change", ()=>{
    state.dayNight = $("#timeSelect").value;
    saveAll();
    renderAll();
  });

  // Main roll
  $("#btnRoll").onclick = ()=> rollOnce({fast:false});

  // Auto roll
  $("#btnAuto").onclick = ()=>{
    if(state.autoOn){ stopAuto(); }
    else{ startAuto(); }
  };

  // Quick roll
  $("#btnQuick").onclick = ()=>{
    if(state.quickOn){ stopQuick(); }
    else{ startQuick(); }
  };

  // Multi roll modal
  $("#btnMulti").onclick = ()=> openModal("multiModal");
  $("#btnDoMulti").onclick = ()=>{
    const n = clamp(Number($("#multiCount").value)||10, 1, 5000);
    for(let i=0;i<n;i++) rollOnce({fast:true});
    renderPreviewKv();
  };
  $("#btnDoMultiFast").onclick = ()=>{
    for(let i=0;i<100;i++) rollOnce({fast:true});
    renderPreviewKv();
  };
  $("#previewAura").addEventListener("change", renderPreviewKv);

  // Auto settings modal
  $("#btnAutoSettings").onclick = ()=> openModal("autoModal");
  $("#autoTarget").addEventListener("change", ()=>{
    state.autoTarget = $("#autoTarget").value;
    saveAll();
  });
  $("#autoStopN").addEventListener("input", ()=>{
    state.autoStopN = Number($("#autoStopN").value)||0;
    saveAll();
  });
  $("#quickBatch").addEventListener("input", ()=>{
    state.quickBatch = Number($("#quickBatch").value)||10;
    saveAll();
  });
  $("#quickInterval").addEventListener("input", ()=>{
    state.quickInterval = Number($("#quickInterval").value)||120;
    saveAll();
  });

  // Store last rolled
  $("#btnStoreLast").onclick = ()=>{
    const last = state.history[0];
    if(!last){ alert("No rolls yet."); return; }
    state.auraStorage.unshift(last);
    state.auraStorage = state.auraStorage.slice(0, 300);
    saveAll(); renderAll();
  };
  $("#btnClearStorage").onclick = ()=>{
    if(confirm("Clear aura storage?")){
      state.auraStorage = [];
      saveAll(); renderAll();
    }
  };
  $("#btnClearInv").onclick = ()=>{
    if(confirm("Clear aura inventory log?")){
      state.auraInventory = [];
      saveAll(); renderAll();
    }
  };

  // Clear history
  $("#btnClearHistory").onclick = ()=>{
    if(confirm("Clear last rolled list?")){
      state.history = [];
      saveAll(); renderAll();
    }
  };

  // Start menu
  $("#btnStartMenu").onclick = ()=> openModal("startModal");

  // Close modals
  $all("[data-close]").forEach(b=>{
    b.onclick = ()=> closeModal(b.getAttribute("data-close"));
  });
  $all(".modalBackdrop").forEach(back=>{
    back.addEventListener("click", (e)=>{
      if(e.target === back) back.style.display = "none";
    });
  });

  // Aura editor / potion editor
  $("#btnOpenAuraEditor").onclick = ()=>{
    $("#auraJson").value = JSON.stringify(AURAS, null, 2);
    openModal("auraEditorModal");
  };
  $("#btnOpenPotionEditor").onclick = ()=>{
    $("#potionJson").value = JSON.stringify(POTIONS, null, 2);
    openModal("potionEditorModal");
  };

  $("#btnCopyAurasJson").onclick = ()=>{
    navigator.clipboard.writeText(JSON.stringify(AURAS, null, 2));
    alert("Copied current auras JSON.");
  };
  $("#btnLoadAurasFromJson").onclick = ()=>{
    try{
      const arr = JSON.parse($("#auraJson").value);
      if(!Array.isArray(arr)) throw new Error("Not an array");
      // Basic validation
      for(const a of arr){
        if(typeof a.name !== "string" || !a.name.trim()) throw new Error("Aura missing name");
        if(!Number.isFinite(a.rarity) || a.rarity < 1) throw new Error(`Bad rarity for ${a.name}`);
      }
      AURAS = arr;
      saveAll();
      renderAll();
      closeModal("auraEditorModal");
    }catch(err){
      alert("Invalid JSON: " + err.message);
    }
  };
  $("#btnRestoreDefaultAuras").onclick = ()=>{
    if(confirm("Restore default auras? This overwrites your current AURAS list.")){
      AURAS = structuredClone(DEFAULT_AURAS);
      saveAll();
      renderAll();
      closeModal("auraEditorModal");
    }
  };

  $("#btnCopyPotionsJson").onclick = ()=>{
    navigator.clipboard.writeText(JSON.stringify(POTIONS, null, 2));
    alert("Copied current potions JSON.");
  };
  $("#btnLoadPotionsFromJson").onclick = ()=>{
    try{
      const arr = JSON.parse($("#potionJson").value);
      if(!Array.isArray(arr)) throw new Error("Not an array");
      for(const p of arr){
        if(typeof p.id !== "string" || !p.id.trim()) throw new Error("Potion missing id");
        if(typeof p.name !== "string" || !p.name.trim()) throw new Error(`Potion ${p.id} missing name`);
        if(!p.type) throw new Error(`Potion ${p.id} missing type`);
      }
      POTIONS = arr;
      saveAll();
      renderAll();
      closeModal("potionEditorModal");
    }catch(err){
      alert("Invalid JSON: " + err.message);
    }
  };
  $("#btnRestoreDefaultPotions").onclick = ()=>{
    if(confirm("Restore default potions? This overwrites your current POTIONS list.")){
      POTIONS = structuredClone(DEFAULT_POTIONS);
      saveAll();
      renderAll();
      closeModal("potionEditorModal");
    }
  };

  // Quick tools
  $("#btnGiveTestItems").onclick = ()=>{
    // give 5 of each potion for testing
    for(const p of POTIONS){
      addItem(p.id, 5);
    }
    saveAll();
    renderAll();
  };
  $("#btnStopAllBuffs").onclick = ()=>{
    state.activeTimed = [];
    state.activeRolls = [];
    state.nextRollLuckAdd = 0;
    saveAll();
    renderAll();
  };

  // Export/Import/Reset
  $("#btnExport").onclick = ()=>{
    const blob = new Blob([JSON.stringify({AURAS, POTIONS, GAUNTLETS, state}, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "sols_rng_save.json";
    a.click();
    URL.revokeObjectURL(url);
  };
  $("#btnImport").onclick = ()=>{
    const inp = document.createElement("input");
    inp.type = "file";
    inp.accept = "application/json";
    inp.onchange = async ()=>{
      const file = inp.files?.[0];
      if(!file) return;
      const txt = await file.text();
      try{
        const obj = JSON.parse(txt);
        if(obj.AURAS) AURAS = obj.AURAS;
        if(obj.POTIONS) POTIONS = obj.POTIONS;
        if(obj.GAUNTLETS) GAUNTLETS = obj.GAUNTLETS;
        if(obj.state) state = obj.state;

        // safety defaults
        state.items ||= {};
        state.activeTimed ||= [];
        state.activeRolls ||= [];
        state.history ||= [];
        state.auraInventory ||= [];
        state.auraStorage ||= [];
        state.dayNight ||= "Day";
        state.theme ||= "dark";
        state.equippedGauntletId ||= "None";

        saveAll();
        // restart timers if needed
        if(state.autoOn){ state.autoOn=false; startAuto(); }
        if(state.quickOn){ state.quickOn=false; startQuick(); }

        renderAll();
        alert("Imported!");
      }catch(err){
        alert("Import failed: " + err.message);
      }
    };
    inp.click();
  };
  $("#btnReset").onclick = ()=>{
    if(confirm("Reset everything (auras, potions, inventory, logs)?")){
      localStorage.removeItem("AURAS");
      localStorage.removeItem("POTIONS");
      localStorage.removeItem("GAUNTLETS");
      localStorage.removeItem("SAVE_STATE");
      AURAS = structuredClone(DEFAULT_AURAS);
      POTIONS = structuredClone(DEFAULT_POTIONS);
      GAUNTLETS = structuredClone(DEFAULT_GAUNTLETS);
      state = loadLS("SAVE_STATE", {
        version: VERSION,
        theme: "dark",
        biome: "",
        dayNight: "Day",
        items: {},
        equippedGauntletId: "None",
        vip: false,
        vipPlus: false,
        activeTimed: [],
        activeRolls: [],
        nextRollLuckAdd: 0,
        history: [],
        auraInventory: [],
        auraStorage: [],
        autoOn:false,
        quickOn:false,
        autoTarget:"Luminosity",
        autoStopN:1000000,
        quickBatch:10,
        quickInterval:120
      });
      stopAuto();
      stopQuick();
      saveAll();
      renderAll();
    }
  };
}

/* ===================== MODALS ===================== */
function openModal(id){
  const el = document.getElementById(id);
  if(el) el.style.display = "flex";
  if(id === "multiModal") renderPreviewSelects();
  if(id === "autoModal") renderPreviewSelects();
  if(id === "startModal") renderStartMenu();
}
function closeModal(id){
  const el = document.getElementById(id);
  if(el) el.style.display = "none";
}

/* ===================== HTML ESCAPE ===================== */
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, (c)=>({
    "&":"&amp;",
    "<":"&lt;",
    ">":"&gt;",
    "\"":"&quot;",
    "'":"&#39;"
  }[c]));
}

/* ===================== TICKER (buff timers) ===================== */
setInterval(()=>{
  // live update timers + stats
  purgeExpired();
  renderAll();
  // keep auto/quick scheduled
}, 1000);

/* ===================== INIT ===================== */
(function main(){
  $("#versionText").textContent = VERSION;

  // Ensure some starter items so you can test immediately (you can remove this)
  if(Object.keys(state.items||{}).length === 0){
    // give a few baseline items
    addItem("LuckyPotion", 10);
    addItem("SpeedPotion", 10);
    addItem("PotionOfBound", 2);
    addItem("HeavenlyPotion", 1);
    addItem("OblivionPotion", 1);
    addItem("WarpPotion", 1);
    addItem("StrangeI", 2);
    addItem("StrangeII", 1);
    saveAll();
  }

  initUI();

  // restart auto/quick if saved on (safe)
  if(state.autoOn){
    state.autoOn = false;
    startAuto();
  }
  if(state.quickOn){
    state.quickOn = false;
    startQuick();
  }

  renderAll();
})();
</script>
</body>
</html>
